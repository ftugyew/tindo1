
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Tindo ‚Äî Login</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="assets/js/redirect-to-localhost.js"></script>
  <script src="js/wish.js" defer></script>
  <link rel="stylesheet" href="css/animations.css">
  <script src="js/script.js" defer></script>
  <style>
    .card { 
      background: linear-gradient(135deg, #ffffff 0%, #f8fffe 100%);
      border: 1px solid #e6f7f0;
      box-shadow: 0 20px 40px rgba(16, 185, 129, 0.1);
    }
    .btn-primary {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
    }
    .btn-secondary {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      color: #374151;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
      border: 1px solid #d1d5db;
      cursor: pointer;
    }
    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
    }

    /* ü•Ñ Spoon Mascot Styles */
    .spoon-container {
      text-align: center;
      margin-bottom: 20px;
    }
    .spoon {
      width: 120px;
      height: auto;
      transition: all 0.4s ease-in-out;
      transform-origin: center;
      display: inline-block;
    }
    .spoon.closed {
      transform: scaleY(0.9) rotate(-5deg);
      filter: brightness(0.8);
    }
    .spoon.happy {
      animation: happyDance 0.6s ease;
    }
    .spoon.sad {
      animation: shakeHead 0.6s ease;
    }
    @keyframes shakeHead {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(10deg); }
      50% { transform: rotate(-10deg); }
      75% { transform: rotate(8deg); }
    }
    @keyframes happyDance {
      0%, 100% { transform: translateY(0); }
      25% { transform: translateY(-8px); }
      50% { transform: translateY(4px); }
      75% { transform: translateY(-4px); }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-green-50 to-white min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-4xl">
    <!-- Header -->
    <header class="flex items-center justify-between p-4 bg-green-600 text-white rounded-t-2xl">
      <img src="assets/tindo-logo.png" alt="Tindo Logo" class="w-12 h-12 rounded-full">
      <h1 class="text-xl font-bold">Tindo</h1>
    </header>

    <!-- ü•Ñ Spoon Mascot -->
    <div class="spoon-container">
      <img src="assets/spoon-mascot.png" alt="Spoon Mascot" id="spoonMascot" class="spoon" />
    </div>

    <div class="text-center mb-8 mt-4">
      <h2 class="text-2xl font-bold text-gray-800 mb-2">Welcome back!</h2>
      <p class="text-gray-600">Sign in to your account to continue</p>
    </div>

    <div class="card rounded-2xl p-8">
      <div class="grid md:grid-cols-2 gap-8">
        <!-- Email login -->
        <div>
          <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
            <span class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">üìß</span>
            Login with Email
          </h3>
          <form id="emailForm" class="space-y-4">
            <div>
              <input id="email_input" placeholder="Enter your email" type="email" 
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-green-100 focus:border-green-400 outline-none transition-all duration-200" required />
            </div>
            <div>
              <input id="password_input" placeholder="Enter your password" type="password" 
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-green-100 focus:border-green-400 outline-none transition-all duration-200" required />
            </div>
            <button type="submit" class="btn-primary w-full py-3 text-lg" data-wish>Sign In</button>
          </form>
          <p class="text-sm text-gray-500 mt-4 text-center">Or use social / phone login</p>
        </div>

        <!-- Phone OTP -->
        <div>
          <h3 class="text-xl font-semibold text-gray-800 mb-6 flex items-center">
            <span class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center mr-3">üì±</span>
            Login with Phone (OTP)
          </h3>
          <div id="otp-area">
            <div class="mb-4">
              <input id="phone_input" placeholder="Enter mobile number (10 digits)" 
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-green-100 focus:border-green-400 outline-none transition-all duration-200"/>
            </div>
            <button id="sendOtpBtn" class="btn-primary w-full py-3 text-lg mb-4" data-wish>Send OTP</button>

            <div id="otp_verification" class="hidden">
              <div class="mb-4">
                <input id="otp_input" placeholder="Enter OTP" 
                  class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-green-100 focus:border-green-400 outline-none transition-all duration-200"/>
              </div>
              <button id="verifyOtpBtn" class="btn-primary w-full py-3 text-lg" data-wish>Verify OTP</button>
            </div>
          </div>
        </div>
      </div>

      <div class="border-t border-gray-200 my-8"></div>

      <!-- Social login -->
      <div>
        <h3 class="text-xl font-semibold text-gray-800 mb-6 text-center">Or continue with</h3>
        <div class="grid grid-cols-2 gap-4">
          <button id="googleBtn" class="btn-secondary py-3 flex items-center justify-center space-x-2" data-wish>
            <span class="text-xl">üîç</span>
            <span>Google</span>
          </button>
          <button id="fbBtn" class="btn-secondary py-3 flex items-center justify-center space-x-2" data-wish>
            <span class="text-xl">üìò</span>
            <span>Facebook</span>
          </button>
        </div>
        <p class="text-xs text-gray-500 mt-4 text-center">Note: Social buttons are currently a development fallback. For production integrate proper OAuth and token verification server-side.</p>
      </div>

      <div class="text-center mt-8">
        <p class="text-gray-600">Don't have an account? 
          <a href="register.html" class="text-green-600 hover:text-green-700 font-semibold transition-colors">Create one here</a>
        </p>
        <a href="index.html" class="text-gray-500 hover:text-gray-700 text-sm mt-2 inline-block">‚Üê Back to Home</a>
      </div>
    </div>
  </div>

<script>
  const BASE = typeof SERVER !== 'undefined' ? SERVER : "http://localhost:5000";

  // ü•Ñ Spoon Mascot Animation Logic
  const spoon = document.getElementById("spoonMascot");
  const passwordField = document.getElementById("password_input");

  passwordField.addEventListener("focus", () => {
    spoon.classList.add("closed");
  });
  passwordField.addEventListener("blur", () => {
    spoon.classList.remove("closed");
  });

  document.getElementById("emailForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("email_input").value.trim();
    const password = document.getElementById("password_input").value.trim();
    try {
      const res = await fetch(`${BASE}/api/auth/login`, {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ email, password })
      });
      const json = await res.json();
      if(res.ok){
        spoon.classList.add("happy");
        setTimeout(()=>spoon.classList.remove("happy"),800);
        localStorage.setItem("token", json.token);
        localStorage.setItem("user", JSON.stringify(json.user));
        if (json.user.role === "admin") window.location.href = "admin-dashboard.html";
        else if (json.user.role === "restaurant") window.location.href = "restaurant-dashboard.html";
        else if (json.user.role === "delivery" || json.user.role === "delivery_agent") window.location.href = "delivery-dashboard.html";
        else window.location.href = "index.html";
      } else {
        spoon.classList.add("sad");
        setTimeout(()=>spoon.classList.remove("sad"),800);
        alert(json.error || "Login failed");
      }
    } catch (err){
      alert("Network error");
      spoon.classList.add("sad");
      setTimeout(()=>spoon.classList.remove("sad"),800);
      console.error(err);
    }
  });

  // --- OTP send/verify ---
  document.getElementById("sendOtpBtn").addEventListener("click", async () => {
    const phone = document.getElementById("phone_input").value.trim().replace(/\D/g,'');
    if(!phone || phone.length < 10) return alert("Enter valid phone");
    try {
      const res = await fetch(`${BASE}/api/otp/send`, {
        method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ phone })
      });
      const json = await res.json();
      if(res.ok){
        alert("OTP sent (check your phone). If in dev, check server console.");
        document.getElementById("otp_verification").classList.remove("hidden");
      } else alert(json.error || "Failed to send OTP");
    } catch(e){ alert("Network error"); console.error(e); }
  });

  document.getElementById("verifyOtpBtn").addEventListener("click", async () => {
    const phone = document.getElementById("phone_input").value.trim().replace(/\D/g,'');
    const otp = document.getElementById("otp_input").value.trim();
    try{
      const res = await fetch(`${BASE}/api/otp/verify`, {
        method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ phone, otp })
      });
      const json = await res.json();
      if(res.ok){
        spoon.classList.add("happy");
        setTimeout(()=>spoon.classList.remove("happy"),800);
        localStorage.setItem("token", json.token);
        localStorage.setItem("user", JSON.stringify(json.user));
        if (json.user.role === "admin") window.location.href = "admin-dashboard.html";
        else if (json.user.role === "restaurant") window.location.href = "restaurant-dashboard.html";
        else if (json.user.role === "delivery" || json.user.role === "delivery_agent") window.location.href = "delivery-dashboard.html";
        else window.location.href = "index.html";
      } else {
        spoon.classList.add("sad");
        setTimeout(()=>spoon.classList.remove("sad"),800);
        alert(json.error || "OTP verify failed");
      }
    } catch(e){ alert("Network error"); console.error(e); }
  });

  document.getElementById("googleBtn").addEventListener("click", ()=>socialFallback("google"));
  document.getElementById("fbBtn").addEventListener("click", ()=>socialFallback("facebook"));
</script>
</body>
</html>
